<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="./img/icon_monocomatico.png">
  <title>Dashboard Musical</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 1fr;
      gap: 20px;
      width: 90%;
      max-width: 1000px;
    }

    /* KPIs no topo */
    .kpis {
      grid-column: 1 / 3;
      display: flex;
      justify-content: space-around;
      background-color: #2c2c2c;
      border-radius: 15px;
      padding: 20px;
    }

    .kpi {
      text-align: center;
      width: 30%;
      border-radius: 10px;
      padding: 15px;
      color: white;
      font-size: 1.1em;
    }

    .violao {
      background-color: #B87C4C;
    }

    /* marrom claro */
    .guitarra {
      background-color: #cbe24a;
    }

    /* azul */
    .baixo {
      background-color: #B7B89F;
    }

    /* roxo */

    /* Gr치ficos */
    .caixa {
      background-color: #d3d3d3;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }

    #graficoBarra {
      width: 100%;
      height: 250px;
    }

    .visao {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #d3d3d3;
      border-radius: 20px;
    }

    #graficoPizza {
      width: 200px;
      height: 200px;
    }
  </style>
</head>

<body>

  <div class="dashboard">
    <div id="msg"></div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi violao">游꿮 Viol칚o <br><strong></strong></div>
      <div class="kpi guitarra">游꿨 Guitarra<br><strong></strong></div>
      <div class="kpi baixo">游꿧 Baixo<br><strong></strong></div>
    </div>



    <!-- Gr치fico de Barras -->
    <div class="caixa">
      <h3>Desempenho por instrumento</h3>
      <canvas id="graficoBarra"></canvas>
    </div>

    <!-- Gr치fico de Pizza -->
    <div class="visao">
      <canvas id="graficoPizza"></canvas>
    </div>

  </div>

  <script>

    nome = sessionStorage.getItem("nomeUsuario");
    document.getElementById("msg").textContent = nome;


    msg.innerHTML = `Ol치 ${nome}`

    // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    // O gr치fico 칠 constru칤do com tr칡s fun칞칫es:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gr치fico da primeira vez
    // 2. plotarGrafico -> Monta o gr치fico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gr치fico, trazendo novamente dados do Banco

    // Esta fun칞칚o *obterDadosGrafico* busca os 칰ltimos dados inseridos em tabela de medidas.
    // para, quando carregar o gr치fico da primeira vez, j치 trazer com v치rios dados.
    // A fun칞칚o *obterDadosGrafico* tamb칠m invoca a fun칞칚o *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de neg칩cio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models

    const instrumento = sessionStorage.INSTRUMENTO;

    let proximaAtualizacao;

    window.onload = obterInstrumentos;

    function obterInstrumentos() {
      console.log("Chamando /medidas/instrumentos ...");

      fetch("/medidas/instrumentos", { cache: 'no-store' })
        .then(function (response) {
          console.log("Resposta recebida:", response);

          if (response.ok) {
            return response.json();
          } else {
            console.error("Nenhum dado encontrado ou erro na API");
          }
        })
        .then(function (dados) {
          console.log("Dados convertidos:", dados);

          if (dados) {
            plotarGraficoInstrumentos(dados);
          }
        })
        .catch(function (erro) {
          console.log("Erro ao buscar instrumentos:", erro);
        });
    }

    // Esta fun칞칚o *plotarGrafico* usa os dados capturados na fun칞칚o anterior para criar o gr치fico
    // Configura o gr치fico (cores, tipo, etc), materializa-o na p치gina e, 
    // A fun칞칚o *plotarGrafico* tamb칠m invoca a fun칞칚o *atualizarGrafico*
    function plotarGraficoInstrumentos(lista) {
      console.log("Iniciando plotagem...");
      console.log("Lista recebida:", lista);

      let labels = [];
      let valores = [];

      lista.forEach(item => {
        console.log("Item:", item);
        labels.push(item.instrumento);
        valores.push(item.quantidade);
      });

      console.log("Labels final:", labels);
      console.log("Valores final:", valores);

      const barra = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de usu치rios por instrumento',
            data: valores,
            backgroundColor: ['#B87C4C', ' #cbe24a', '#B7B89F'],
            borderWidth: 1
          }]
        }
      };

      new Chart(
        document.getElementById("graficoBarra"),
        barra
      );


      const pizza = {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de usu치rios por instrumento',
            data: valores,
            backgroundColor: ['#B87C4C', ' #cbe24a', '#B7B89F'],
            borderWidth: 1
          }]
        }
      };

      new Chart(
        document.getElementById("graficoPizza"),
        pizza
      );

      // console.log('----------------------------------------------')
      // console.log('O gr치fico ser치 plotado com os respectivos valores:')
      // console.log('Labels:')
      // console.log(labels)
      // console.log('Dados:')
      // console.log(dados.datasets)
      // console.log('----------------------------------------------')

      console.log("Gr치fico criado!");
    }


    // Esta fun칞칚o *atualizarGrafico* atualiza o gr치fico que foi renderizado na p치gina,
    // buscando a 칰ltima medida inserida em tabela contendo as capturas,

    //     Se quiser alterar a busca, ajuste as regras de neg칩cio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    // function atualizarGrafico(instrumento, dados, myChart) {



    //     fetch(`/medidas/tempo-real/${instrumento}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (novoRegistro) {

    //                 obterdados(instrumento);
    //                 // alertar(novoRegistro, instrumento);
    //                 console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
    //                 console.log(`Dados atuais do gr치fico:`);
    //                 console.log(dados);

    //                 let avisoCaptura = document.getElementById(`avisoCaptura${instrumento}`)
    //                 avisoCaptura.innerHTML = ""


    //                 if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
    //                     console.log("---------------------------------------------------------------")
    //                     console.log("Como n칚o h치 dados novos para captura, o gr치fico n칚o atualizar치.")
    //                     avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como n칚o h치 dados novos a exibir, o gr치fico n칚o atualizar치."
    //                     console.log("Hor치rio do novo dado capturado:")
    //                     console.log(novoRegistro[0].momento_grafico)
    //                     console.log("Hor치rio do 칰ltimo dado capturado:")
    //                     console.log(dados.labels[dados.labels.length - 1])
    //                     console.log("---------------------------------------------------------------")
    //                 } else {
    //                     // tirando e colocando valores no gr치fico
    //                     dados.labels.shift(); // apagar o primeiro
    //                     dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

    //                     dados.datasets[0].data.shift();  // apagar o primeiro de umidade
    //                     dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

    //                     dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
    //                     dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

    //                     myChart.update();
    //                 }

    //                 // Altere aqui o valor em ms se quiser que o gr치fico atualize mais r치pido ou mais devagar
    //                 proximaAtualizacao = setTimeout(() => atualizarGrafico(instrumento, dados, myChart), 2000);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //             // Altere aqui o valor em ms se quiser que o gr치fico atualize mais r치pido ou mais devagar
    //             proximaAtualizacao = setTimeout(() => atualizarGrafico(instrumento, dados, myChart), 2000);
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obten칞칚o dos dados p/ gr치fico: ${error.message}`);
    //         });

    // }



  </script>

</body>

</html>