<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="./img/icon_monocomatico.png">
  <title>Dashboard Musical</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #000000;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 1fr;
      gap: 20px;
      width: 90%;
      max-width: 1000px;
    }


    .kpis {
      grid-column: 1 / 3;
      display: flex;
      justify-content: space-around;
      background-color: #2c2c2c;
      border-radius: 15px;
      padding: 20px;
    }

    .kpi {
      text-align: center;
      width: 30%;
      border-radius: 10px;
      padding: 15px;
      color: white;
      font-size: 1.1em;
    }

    .violao {
      background-color: #B87C4C;
    }


    .guitarra {
      background-color: #cbe24a;
    }


    .baixo {
      background-color: #B7B89F;
    }


    .caixa {
      background-color: #d3d3d3;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }

    #graficoBarra {
      width: 100%;
      height: 250px;
    }

    .visao {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background-color: #d3d3d3;
      border-radius: 20px;
    }

    #graficoPizza {
      width: 200px;
      height: 200px;
    }

    button {
      border: 0;
      outline: none;
      margin-top: 1%;
      font-size: 20px;
      background-color: transparent;
      border: solid #fffdfd;
      border-radius: 10px;
      padding: 0 20px;
      border-width: 2px;
      cursor: pointer;
      color: #fff;
    }
  </style>
</head>

<body>
  
  <div class="dashboard">
    <div id="msg">Olá </div>
    
    <div class="kpis">
      <span style="color: #B7B89F;">Instrumento mais tocado:</span>
      <div class="kpi violao" id="kpiInstrumento" style="color: #000000;" > </div>
      <div class="kpi baixo"  style="color: #000000;" id="kpiQuantidade"><br><strong></strong></div>
    </div>

    <div class="caixa">
      <h3>Desempenho por instrumento</h3>
      <canvas id="graficoBarra"></canvas>
    </div>

    <!-- Gráfico de Pizza -->
    <div class="visao">
      <canvas id="graficoPizza"></canvas>
    </div>

  </div>

  <button onclick="quiz()">Teste seu conhecimento</button>

  <script>

    // nome = sessionStorage.getItem("nomeUsuario");
    // document.getElementById("msg").textContent = nome;



    msg.innerHTML = sessionStorage.NOME_USUARIO;
    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models

    const instrumento = sessionStorage.INSTRUMENTO;

    let proximaAtualizacao;

    window.onload = () => {
      obterInstrumentos();
      obterMusica();
      mostrarKpis()
    };

    function obterInstrumentos() {
      console.log("Chamando /medidas/instrumentos ...");

      fetch("/medidas/instrumentos", { cache: 'no-store' })
        .then(function (response) {
          console.log("Resposta recebida:", response);

          if (response.ok) {
            return response.json();
          } else {
            console.error("Nenhum dado encontrado ou erro na API");
          }
        })
        .then(function (dados) {
          console.log("Dados convertidos:", dados);

          if (dados) {
            plotarGraficoInstrumentos(dados);
          }
        })
        .catch(function (erro) {
          console.log("Erro ao buscar instrumentos:", erro);
        });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGraficoInstrumentos(lista) {
      console.log("Iniciando plotagem...");
      console.log("Lista recebida:", lista);

      let instrumentos = [];
      let valores = [];

      lista.forEach(item => {
        console.log("Item:", item);
        instrumentos.push(item.instrumento);
        valores.push(item.quantidade);
      });

      console.log("Labels final:", instrumentos);
      console.log("Valores final:", valores);

      const barra = {
        type: 'bar',
        data: {
          labels: instrumentos,
          datasets: [{
            label: 'Quantidade de usuários por instrumento',
            data: valores,
            backgroundColor: ['#B87C4C', '#cbe24a', '#B7B89F'],
            borderWidth: 1
          }]
        }
      };

      new Chart(
        document.getElementById("graficoBarra"),
        barra
      );
    }

    function obterMusica() {
      console.log("Chamando /medidas/musica ...");

      fetch("/medidas/musica", { cache: 'no-store' })
        .then(function (response) {
          console.log("Resposta recebida:", response);

          if (response.ok) {
            return response.json();
          } else {
            console.error("Nenhum dado encontrado ou erro na API");
          }
        })
        .then(function (dados) {
          console.log("Dados convertidos:", dados);

          if (dados) {
            plotarGraficoMusica(dados);
          }
        })
        .catch(function (erro) {
          console.log("Erro ao buscar musica:", erro);
        });
    }

    function plotarGraficoMusica(lista) {
      console.log("Iniciando plotagem...");
      console.log("Lista recebida:", lista);

      let qtdusicas = [];
      let valoresMusica = [];

      lista.forEach(item => {
        console.log("Item:", item);
        qtdusicas.push(item.musica);
        valoresMusica.push(item.quantidade);
      });

      console.log("Labels final:", qtdusicas);
      console.log("Valores final:", valoresMusica);

      const pizza = {
        type: 'pie',
        data: {
          labels: qtdusicas,
          datasets: [{
            label: 'Quantidade de musicas tocadas pelo usuario',
            data: valoresMusica,
            backgroundColor: ['#B87C4C', ' #cbe24a', '#B7B89F'],
            borderWidth: 1
          }]
        }
      };

      new Chart(
        document.getElementById("graficoPizza"),
        pizza
      );

      console.log("Gráfico criado!");
    }

    function mostrarKpis() {
      console.log("Chamando /medidas/instrumentos ...");

      fetch("/medidas/instrumentos", { cache: 'no-store' })
        .then(function (response) {
          console.log("Resposta recebida:", response);


          if (response.ok) {
            return response.json();
          } else {
            console.error("Nenhum dado encontrado ou erro na API");
          }
        })
        .then(function (dados) {
          console.log("Dados convertidos:", dados);

          if (dados) {

            var maisTocado = dados[0];

            for (var i = 1; i < dados.length; i++) {
              if (dados[i].quantidade > maisTocado.quantidade) {
                maisTocado = dados[i];
              }
            }


            console.log("Instrumento mais tocado:", maisTocado.instrumento);
            console.log("Quantidade:", maisTocado.quantidade);

            kpiInstrumento.innerHTML = maisTocado.instrumento;
            kpiQuantidade.innerHTML = maisTocado.quantidade;

            document.getElementById("kpiInstrumento").innerHTML = maisTocado.instrumento;
            document.getElementById("kpiQuantidade").innerHTML = maisTocado.quantidade;
          }
        })
        .catch(function (erro) {
          console.log("Erro ao buscar instrumentos:", erro);
        });
    }

    function quiz() {
      window.location = `Quiz.html`
    }





  </script>

</body>

</html>